<div class="p-4">
  <p-toast></p-toast>
  <app-header-page [title]="'Gestión de Tickets'" [icon]="'pi pi-ticket'"></app-header-page>

  <div class="mt-4">
    <div class="flex align-items-center justify-content-end mb-4">
      <p-button label="Crear Ticket" icon="pi pi-plus" (click)="openNewTicketDialog()"></p-button>
    </div>

    <p-table [value]="tickets()" [paginator]="true" [rows]="10" [loading]="loading" [rowHover]="true"
      responsiveLayout="scroll" styleClass="p-datatable-sm">

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="id" style="width: 10%">ID <p-sortIcon field="id"></p-sortIcon></th>
          <th pSortableColumn="type" style="width: 20%">Tipo <p-sortIcon field="type"></p-sortIcon></th>
          <th pSortableColumn="priority" style="width: 15%">Prioridad <p-sortIcon field="priority"></p-sortIcon></th>
          <th pSortableColumn="subject">Asunto <p-sortIcon field="subject"></p-sortIcon></th>
          <th pSortableColumn="status" style="width: 15%">Estado <p-sortIcon field="status"></p-sortIcon></th>
          <th pSortableColumn="createdAt" style="width: 15%">Fecha <p-sortIcon field="createdAt"></p-sortIcon></th>
          <th style="width: 10%"></th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-ticket>
        <tr>
          <td><span class="font-bold">{{ ticket.customId || ticket.id }}</span></td>
          <td><p-tag [value]="getTypeLabel(ticket.type)" [severity]="getTypeSeverity(ticket.type)"></p-tag></td>
          <td><p-tag [value]="getPriorityLabel(ticket.priority)"
              [severity]="getPrioritySeverity(ticket.priority)"></p-tag></td>
          <td>{{ ticket.subject }}</td>
          <td><p-tag [value]="getStatusLabel(ticket.status)" [severity]="getStatusSeverity(ticket.status)"
              [rounded]="true"></p-tag>
          </td>
          <td>{{ ticket.createdAt | date:'dd/MM/yyyy' }}</td>
          <td>
            <p-button [label]="(userRole === Roles.ADMIN && ticket.status !== 'CLOSED') ? 'Gestionar' : 'Consultar'"
              [icon]="(userRole === Roles.ADMIN && ticket.status !== 'CLOSED') ? 'pi pi-cog' : 'pi pi-eye'"
              [outlined]="!(userRole === Roles.ADMIN && ticket.status !== 'CLOSED')"
              [severity]="(userRole === Roles.ADMIN && ticket.status !== 'CLOSED') ? 'info' : 'secondary'" styleClass="p-button-sm"
              (click)="viewTicket(ticket)"></p-button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center p-6">
            <div class="flex flex-column align-items-center justify-content-center">
              <div class="surface-100 border-circle flex align-items-center justify-content-center mb-3" style="width: 4rem; height: 4rem">
                <i class="pi pi-inbox text-4xl text-500"></i>
              </div>
              <span class="text-900 font-medium text-lg mb-1">No hay tickets abiertos</span>
              <span class="text-500">Actualmente no tienes ninguna incidencia pendiente.</span>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- CREAR TICKET -->
<p-dialog [(visible)]="displayDialog" [style]="{width: '650px'}" header="Crear Nuevo Ticket" [modal]="true"
  styleClass="p-fluid" [draggable]="false" [resizable]="false">
  <ng-template pTemplate="content">
    <form [formGroup]="ticketForm" class="flex flex-column gap-3 mt-2">
      <div class="field">
        <label for="subject" class="font-bold block mb-2">Asunto</label>
        <input type="text" pInputText class="w-full" id="subject" formControlName="subject"
          placeholder="Resumen del problema" />
        <p-message *ngIf="ticketForm.get('subject')?.invalid && ticketForm.get('subject')?.touched"
            severity="error" variant="simple" size="small">El asunto es obligatorio</p-message>
      </div>

      <div class="field">
        <label for="type" class="font-bold block mb-2">Tipo</label>
        <p-select id="type" class="w-full" [options]="ticketTypes" formControlName="type"
          placeholder="Selecciona un tipo" appendTo="body"></p-select>
        <p-message *ngIf="ticketForm.get('type')?.invalid && ticketForm.get('type')?.touched"
            severity="error" variant="simple" size="small">El tipo es obligatorio</p-message>
      </div>

      <div class="field">
        <label for="priority" class="font-bold block mb-2">Prioridad</label>
        <p-select id="priority" class="w-full" [options]="priorities" formControlName="priority"
          placeholder="Selecciona una prioridad" appendTo="body"></p-select>
          <p-message *ngIf="ticketForm.get('priority')?.invalid && ticketForm.get('priority')?.touched"
            severity="error" variant="simple" size="small">La prioridad es obligatoria</p-message>
      </div>

      <div *ngIf="isAnimalScaling" class="flex flex-column gap-3">
        <div class="field">
          <label for="animal" class="font-bold block mb-2">Animal a Escalar</label>
          <p-select [options]="animals()" formControlName="animalId" placeholder="Selecciona un animal"
            [style]="{'width':'100%'}" [filter]="true" filterBy="label" filterPlaceholder="Buscar animal..."
            appendTo="body"></p-select>
          <p-message *ngIf="ticketForm.get('animalId')?.invalid && ticketForm.get('animalId')?.touched"
            severity="error" variant="simple" size="small">El animal es obligatorio</p-message>
        </div>
        <div class="field">
          <label for="description" class="font-bold block mb-2">Motivo del Escalado</label>
          <textarea id="description" class="w-full" pInputTextarea formControlName="description" rows="5"
            placeholder="Detalla el motivo del escalado..."></textarea>
          <p-message *ngIf="ticketForm.get('description')?.invalid && ticketForm.get('description')?.touched"
            severity="error" variant="simple" size="small">Este campo es obligatorio</p-message>
        </div>
      </div>

      <div *ngIf="!isAnimalScaling">
        <div class="field">
          <label for="description" class="font-bold block mb-2">Descripción</label>
          <textarea id="description" class="w-full" pInputTextarea formControlName="description" rows="5"
            placeholder="Detalla el problema..."></textarea>
          <p-message *ngIf="ticketForm.get('description')?.invalid && ticketForm.get('description')?.touched"
            severity="error" variant="simple" size="small">La descripción es obligatoria</p-message>
        </div>
      </div>
    </form>
  </ng-template>

  <ng-template pTemplate="footer">
    <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text"
      (click)="displayDialog = false"></button>
    <button pButton pRipple label="Crear" icon="pi pi-check" class="p-button-text" (click)="saveTicket()"></button>
  </ng-template>
</p-dialog>

<!-- VER DETALLES DEL TICKET -->
<p-dialog [(visible)]="displayViewDialog" [style]="{width: '650px', maxWidth: '95vw'}" [modal]="true"
  [draggable]="false" [resizable]="false" [showHeader]="false" styleClass="p-fluid border-round-2xl shadow-none"
  [dismissableMask]="true">
  <ng-template pTemplate="content">
    <div *ngIf="selectedTicket" class="flex flex-column pt-5 px-2 pb-0">

      <!-- Header: Date & Close -->
      <div class="flex justify-content-between align-items-center mb-2">
        <span class="text-500 text-sm font-medium bg-surface-100 px-2 py-1 border-round">{{ selectedTicket.createdAt |
          date:'d MMM yyyy, HH:mm' }}</span>
        <button pButton pRipple icon="pi pi-times"
          class="p-button-rounded p-button-text p-button-secondary w-2rem h-2rem"
          (click)="displayViewDialog = false"></button>
      </div>

      <!-- Subject -->
      <h2 class="text-2xl font-bold text-900 m-0 mb-3 line-height-2">{{ selectedTicket.subject }}</h2>

      <!-- Status & ID Row -->
      <div class="flex align-items-center gap-3 mb-4">
        <div class="flex align-items-center gap-2">
          <p-tag [value]="getStatusLabel(selectedTicket.status)" [severity]="getStatusSeverity(selectedTicket.status)"
            [rounded]="true" class="px-3 font-bold"></p-tag>
        </div>

        <span class="text-500 text-sm">ID: <span class="text-700 font-medium">{{ selectedTicket.customId ||
            selectedTicket.id }}</span></span>
      </div>

      <!-- User Info for Open Tickets -->
      <div *ngIf="selectedTicket.status === 'OPEN' && userRole !== Roles.ADMIN" class="surface-50 p-3 border-round-xl mb-4 border-1 surface-border flex align-items-start gap-3">
        <i class="pi pi-info-circle text-blue-500 text-xl mt-1"></i>
        <div class="flex flex-column gap-2">
          <span class="text-900 font-medium">Ticket Recibido</span>
          <span class="text-700 line-height-3">Tu ticket ha sido recibido correctamente. Un administrador lo revisará pronto.</span>
        </div>
      </div>

      <!-- User Info for In Progress Tickets -->
      <div *ngIf="selectedTicket.status === 'IN_PROGRESS' && userRole !== Roles.ADMIN" class="surface-50 p-3 border-round-xl mb-4 border-1 surface-border flex align-items-start gap-3">
        <i class="pi pi-info-circle text-blue-500 text-xl mt-1"></i>
        <div class="flex flex-column gap-2">
          <span class="text-900 font-medium">En Revisión</span>
          <span class="text-700 line-height-3">Tu ticket está siendo revisado actualmente.</span>
        </div>
      </div>

      <div *ngIf="selectedTicket.status === 'ON_HOLD' && userRole !== Roles.ADMIN && !selectedTicket.userResponse"
        class="surface-50 p-3 border-round-xl mb-4 border-1 surface-border flex align-items-start gap-3">
        <i class="pi pi-info-circle text-orange-500 text-xl mt-1"></i>
        <div class="flex flex-column gap-2">
          <span class="text-900 font-medium">Tu ticket está en espera de información adicional.</span>
          <span class="text-700 line-height-3">Hemos revisado tu caso, pero necesitamos que respondas al último mensaje del administrador para poder continuar.</span>
        </div>
      </div>

      <div *ngIf="selectedTicket.status === 'ON_HOLD' && userRole === Roles.ADMIN && selectedTicket.userResponse"
        class="surface-50 p-3 border-round-xl mb-4 border-1 surface-border flex align-items-start gap-3">
        <i class="pi pi-info-circle text-blue-500 text-xl mt-1"></i>
        <div class="flex flex-column gap-2">
          <span class="text-900 font-medium">Respuesta del Usuario Recibida</span>
          <span class="text-700 line-height-3">El usuario ha respondido a la solicitud. Revisa la respuesta y actualiza el estado del ticket.</span>
        </div>
      </div>

      <!-- Admin Options -->
      <div *ngIf="userRole === Roles.ADMIN" class="surface-50 p-3 border-round-xl mb-4 border-1 surface-border">
        <span class="text-xs font-bold text-500 uppercase tracking-wide block mb-2">Acciones de Gestión</span>
        <div class="flex gap-2 flex-wrap">
          <button *ngIf="selectedTicket.status === 'OPEN'" pButton label="Empezar a trabajar" icon="pi pi-play" class="p-button-sm" (click)="updateTicketStatus('IN_PROGRESS')"></button>

          <ng-container *ngIf="selectedTicket.status === 'IN_PROGRESS'">
            <button pButton label="Poner en espera" icon="pi pi-pause" class="p-button-sm p-button-warning" (click)="updateTicketStatus('ON_HOLD')"></button>
            <button pButton label="Resolver" icon="pi pi-check" class="p-button-sm p-button-success" (click)="updateTicketStatus('CLOSED')"></button>
          </ng-container>

          <button *ngIf="selectedTicket.status === 'ON_HOLD'" pButton label="Reanudar trabajo" icon="pi pi-refresh" class="p-button-sm" (click)="updateTicketStatus('IN_PROGRESS')"></button>

          <button *ngIf="selectedTicket.status === 'CLOSED'" pButton label="Reabrir" icon="pi pi-undo" class="p-button-sm p-button-warning" (click)="updateTicketStatus('OPEN')"></button>

          <button *ngIf="selectedTicket.status !== 'CLOSED'" pButton label="Asignar" icon="pi pi-user-plus" class="p-button-sm p-button-outlined" (click)="displayAssignDialog = true"></button>
          <button *ngIf="selectedTicket.status !== 'OPEN' && selectedTicket.status !== 'CLOSED'" pButton label="Responder" icon="pi pi-reply" class="p-button-sm p-button-outlined" (click)="displayNoteDialog = true; replyMessage = ''"></button>
        </div>
      </div>

      <!-- User Options for On Hold -->
      <div *ngIf="selectedTicket.status === 'ON_HOLD' && userRole === Roles.MOD" class="surface-50 p-3 border-round-xl mb-4 border-1 surface-border">
        <span class="text-xs font-bold text-500 uppercase tracking-wide block mb-2">Acciones Requeridas</span>
        <button pButton label="Responder" icon="pi pi-reply" class="p-button-sm" (click)="displayNoteDialog = true; replyMessage = ''"></button>
      </div>

      <!-- Info Grid (Type & Priority) -->
      <div class="grid grid-nogutter surface-50 border-round-xl p-3 mb-4 border-1 surface-border">
        <div class="col-6 flex flex-column gap-1 border-right-1 surface-border pr-3">
          <span class="text-xs font-bold text-500 uppercase tracking-wide">Tipo</span>
          <div class="flex align-items-center gap-2 text-800">
            <i class="pi pi-tag text-primary-500"></i>
            <span class="font-medium text-sm">{{ getTypeLabel(selectedTicket.type) }}</span>
          </div>
        </div>
        <div class="col-6 flex flex-column gap-1 mt-3">
          <span class="text-xs font-bold text-500 uppercase tracking-wide">Prioridad</span>
          <div class="flex align-items-center gap-2 text-800">
            <i class="pi pi-flag-fill" [class.text-green-500]="selectedTicket.priority === 'LOW'"
              [class.text-orange-500]="selectedTicket.priority === 'MEDIUM'"
              [class.text-red-500]="selectedTicket.priority === 'HIGH'"></i>
            <span class="font-medium text-sm">{{ getPriorityLabel(selectedTicket.priority) }}</span>
          </div>
        </div>
      </div>

      <!-- Animal Context -->
      <div *ngIf="selectedTicket.animalId" class="mb-4">
        <div
          class="flex align-items-center gap-3 p-3 border-1 surface-border border-round-xl bg-white shadow-sm hover:shadow-2 transition-duration-200 transition-all">
          <div
            class="w-2rem h-2rem border-circle bg-pink-50 text-pink-500 flex align-items-center justify-content-center flex-shrink-0">

            <i class="fa-solid text-sm" [ngClass]="{'fa-cat': getAnimalLabel(selectedTicket.animalId).includes('Gato'),
              'fa-dog': getAnimalLabel(selectedTicket.animalId).includes('Perro')}"></i>
          </div>
          <div class="flex flex-column overflow-hidden flex-1">
            <span class="text-xs text-500 font-bold uppercase mb-1">Animal Relacionado</span>
            <span class="text-900 font-medium white-space-nowrap overflow-hidden text-overflow-ellipsis">{{
              getAnimalLabel(selectedTicket.animalId) }}</span>
          </div>
          <button pButton icon="pi pi-external-link" [rounded]="true" [text]="true" pTooltip="Ver Ficha"
            (click)="viewAnimal(selectedTicket.animalId)"></button>
        </div>
      </div>

      <!-- Description -->
      <div class="flex flex-column gap-2 mb-4">
        <span class="text-xs font-bold text-500 uppercase tracking-wide">Descripción del Problema</span>
        <div class="surface-50 p-3 border-round-xl border-1 surface-border shadow-sm">
          <div class="text-800 line-height-3 text-base" style="white-space: pre-wrap;">{{ selectedTicket.description }}</div>
        </div>
      </div>

      <!-- Admin Response -->
      <div *ngIf="selectedTicket.adminResponse" class="flex flex-column gap-2 mt-3 pt-3 border-top-1 surface-border">
        <span class="text-xs font-bold text-500 uppercase tracking-wide">Respuesta del Administrador</span>
        <div class="surface-50 p-3 border-round-xl border-1 surface-border">
          <div class="text-xs text-500 mb-2 flex align-items-center gap-2">
            <i class="pi pi-user text-primary"></i>
            <span class="font-bold text-700">{{ selectedTicket.adminResponse.adminName }}</span>
            <span class="text-300">|</span>
            <span>{{ selectedTicket.adminResponse.date | date:'d MMM yyyy, HH:mm' }}</span>
          </div>
          <div class="text-800 line-height-3" style="white-space: pre-wrap;">{{ selectedTicket.adminResponse.message }}</div>
        </div>
      </div>

      <!-- User Response -->
      <div *ngIf="selectedTicket.userResponse" class="flex flex-column gap-2 mt-3 pt-3 border-top-1 surface-border">
        <span class="text-xs font-bold text-500 uppercase tracking-wide">Respuesta del Usuario</span>
        <div class="surface-50 p-3 border-round-xl border-1 surface-border">
          <div class="text-xs text-500 mb-2 flex align-items-center gap-2">
            <i class="pi pi-user text-primary"></i>
            <span class="font-bold text-700">{{ selectedTicket.userResponse.userName }}</span>
            <span class="text-300">|</span>
            <span>{{ selectedTicket.userResponse.date | date:'d MMM yyyy, HH:mm' }}</span>
          </div>
          <div class="text-800 line-height-3" style="white-space: pre-wrap;">{{ selectedTicket.userResponse.message }}</div>
        </div>
      </div>

    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <div class="flex justify-content-end pt-3 border-top-1 surface-border mt-2">
      <button pButton pRipple label="Cerrar" class="p-button-text p-button-secondary font-bold"
        (click)="displayViewDialog = false"></button>
    </div>
  </ng-template>
</p-dialog>

<!-- DIALOGO ASIGNAR -->
<p-dialog [(visible)]="displayAssignDialog" header="Asignar Ticket" [modal]="true" [style]="{width: '400px'}" styleClass="p-fluid">
    <ng-template pTemplate="content">
        <div class="field mt-2">
            <label for="technician">Técnico</label>
            <p-select [options]="technicians" [(ngModel)]="selectedTechnician" optionLabel="name" placeholder="Seleccionar técnico" appendTo="body"></p-select>
        </div>
    </ng-template>
    <ng-template pTemplate="footer">
        <button pButton label="Cancelar" class="p-button-text" (click)="displayAssignDialog = false"></button>
        <button pButton label="Asignar" (click)="assignTicket()"></button>
    </ng-template>
</p-dialog>

<!-- DIALOGO RESPONDER -->
<p-dialog [(visible)]="displayNoteDialog" header="Responder" [modal]="true" [style]="{width: '500px'}" styleClass="p-fluid">
  <ng-template pTemplate="content">
    <div *ngIf="pendingStatus === 'ON_HOLD' && userRole === Roles.ADMIN" class="surface-50 p-3 border-round-xl mb-4 border-1 surface-border flex align-items-center gap-3">
        <i class="pi pi-info-circle text-blue-500 text-xl"></i>
        <span class="text-700 line-height-3">Debe ingresar un mensaje para poner el ticket en espera.</span>
      </div>
    <div class="field mt-2">
        <label for="note">Respuesta</label>
        <textarea pInputTextarea [(ngModel)]="replyMessage" rows="5" class="w-full" placeholder="Escribe una respuesta..."></textarea>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
      <button pButton label="Cancelar" class="p-button-text" (click)="displayNoteDialog = false"></button>
      <button pButton label="Enviar" (click)="sendReply()"></button>
  </ng-template>
</p-dialog>
