<div class="profile-container">
  <app-header-page [title]="'Mi perfil'" [icon]="'fas fa-user'"></app-header-page>

  <div class="card flex justify-center" *ngIf="!(currentUser$ | async)">
    <p-progressSpinner strokeWidth="4" animationDuration=".5s" [style]="{ width: '50px', height: '50px' }" />
  </div>

  <div *ngIf="currentUser$ | async as user" class="mt-4">

    <!-- Vista para Administradores y Moderadores -->
    <div *ngIf="user.role === Roles.ADMIN || user.role === Roles.MOD" class="max-w-4xl mx-auto">
      <p-card>
        <ng-template pTemplate="header">
          <div class="profile-header admin-header flex items-center p-4">
            <p-avatar [label]="user.username.charAt(0).toUpperCase()" styleClass="mr-4" size="xlarge" shape="circle" [style]="getUserAvatarColor(user.username)"></p-avatar>
            <div>
              <h2 class="text-2xl font-bold m-0">{{ user.username }}</h2>
              <p class="text-lg m-0 text-surface-500">{{ user.email }}</p>
            </div>
          </div>
        </ng-template>
        <div class="flex items-center">
          <p class="font-semibold mr-3">Rol en la plataforma:</p>
          <p-tag *ngIf="user.role === Roles.ADMIN" icon="fa fa-user-cog" severity="danger" value="Administrador" [rounded]="true" />
          <p-tag *ngIf="user.role === Roles.MOD" icon="fa fa-user-pen" severity="warn" value="Moderador" [rounded]="true" />
        </div>

        <!-- Mensaje para Administradores -->
        <p class="mt-3" *ngIf="user.role === Roles.ADMIN">Tienes acceso total al panel de control para administrar animales, solicitudes y usuarios.</p>

        <!-- Mensaje dinámico para Moderadores -->
        <div *ngIf="user.role === Roles.MOD" class="mt-3">
          <!-- Si tiene permisos, muestra la lista -->
          <div *ngIf="user.permissions && user.permissions.length > 0; else noPermissions">
            <p>Como moderador, puedes acceder al panel de control para realizar las siguientes tareas:</p>
            <ul class="list-disc pl-6 mt-2">
              <li *ngIf="user.permissions?.includes(Permissions.MANAGE_ANIMALS)" class="mb-2">
                <strong>Gestionar animales:</strong><span class="text-surface-500"> Revisar, editar y publicar las fichas de los animales.</span>
              </li>
              <li *ngIf="user.permissions?.includes(Permissions.MANAGE_REQUESTS)" class="mb-2">
                <strong>Gestionar solicitudes:</strong><span class="text-surface-500"> Revisar y procesar las solicitudes de adopción.</span>
              </li>
              <li *ngIf="user.permissions?.includes(Permissions.MANAGE_USERS)" class="mb-2">
                <strong>Gestionar usuarios:</strong><span class="text-surface-500"> Modificar roles y permisos de otros usuarios.</span>
              </li>
              <li *ngIf="user.permissions?.includes(Permissions.ADD_ANIMALS)" class="mb-2">
                <strong>Añadir animales:</strong><span class="text-surface-500"> Crear nuevas fichas de animales en la plataforma.</span>
              </li>
              <li *ngIf="user.permissions?.includes(Permissions.ADD_PROTECTORS)" class="mb-2">
                <strong>Añadir protectoras:</strong><span class="text-surface-500"> Registrar nuevas protectoras en el sistema.</span>
              </li>
            </ul>
          </div>
          <!-- Si no tiene permisos, muestra este mensaje -->
          <ng-template #noPermissions>
            <p class="text-surface-500">Actualmente no tienes permisos de gestión asignados. Por favor, contacta a un administrador para solicitarlos.</p>
          </ng-template>
        </div>

        <!-- Nueva sección de Notas para MOD y ADMIN -->
        <p-divider></p-divider>
        <div class="mt-4">
          <h3 class="font-semibold text-xl mb-3">Mis Notas Internas</h3>
          @if (user.notes && user.notes.length > 0) {
          <ul class="list-none p-0 m-0 space-y-4">
            @for (note of user.notes | orderByDate:'desc'; track note) {
            <li class="note-record border rounded-lg overflow-hidden shadow-sm">
              <div class="note-header bg-surface-50 p-3 flex justify-between items-center border-b ">
                <div class="font-semibold text-surface-700 flex items-center gap-2">
                  <p-avatar [label]="note.authorName.charAt(0).toUpperCase()" shape="circle" size="normal" [style]="getUserAvatarColor(note.authorName)"></p-avatar>
                  <span>{{note.authorName}}</span>
                </div>
                <span class="text-sm text-surface-500">{{note.createdAt.toDate() | date:'dd/MM/yyyy HH:mm'}}</span>
              </div>
              <div class="note-body p-3">
                <p class="m-0 text-surface-800">{{note.content}}</p>
              </div>
            </li>
            }
          </ul>
          } @else {
          <p class="text-surface-500">No tienes ninguna nota interna.</p>
          }
        </div>

        <ng-template pTemplate="footer">
          <div class="flex justify-end">
            <p-button label="Ir al Panel de Gestión" icon="pi pi-cog" routerLink="/panel-gestion"></p-button>
          </div>
        </ng-template>
      </p-card>
    </div>

    <!-- Vista para Usuarios por defecto -->
    <div *ngIf="user.role === Roles.DEFAULT" class="max-w-4xl mx-auto">
      <p-card>
        <ng-template pTemplate="title">
          <div class="flex items-center gap-4">
            <p-avatar [label]="user.username.charAt(0).toUpperCase()" size="xlarge" shape="circle" [style]="getUserAvatarColor(user.username)"></p-avatar>
            <div>
              <h2 class="text-2xl font-bold m-0">{{ user.username }}</h2>
              <p class="text-lg m-0 text-surface-500">{{ user.email }}</p>
            </div>
          </div>
        </ng-template>
        <ng-template pTemplate="content">
          <p-divider></p-divider>
          <div class="mt-4">
            <h3 class="font-semibold text-xl mb-3">Mis Solicitudes de Adopción</h3>
            <p class="text-surface-600 mb-4">Aquí podrás ver el estado de las solicitudes que has enviado.</p>

            <ng-container *ngIf="!requestsLoading; else loadingRequests">
              <div *ngIf="adoptionRequests.length > 0; else noRequests" class="space-y-4">
                <!-- Itera sobre cada solicitud y la muestra como una tarjeta -->
                <div *ngFor="let request of adoptionRequests"
                  class="p-4 border rounded-lg flex flex-col sm:flex-row items-center justify-between gap-4 shadow-sm transition-shadow hover:shadow-md">
                  <div class="flex items-center gap-4 w-full sm:w-auto">
                    <img [src]="request.animalData?.urlImage" [alt]="request.animal?.name"
                      class="w-20 h-20 object-cover rounded-lg">
                    <div>
                      <h4 class="text-lg font-bold m-0">{{ request.animalData?.name || 'Animal no disponible' }}</h4>
                      <p class="text-sm text-surface-500 m-0">
                        {{ request.animalData?.protectressName || 'Protectora no disponible' }}
                      </p>
                      <p class="text-xs text-surface-400 m-0 mt-1">Solicitud del {{ request.requestData.createdAt?.toDate() |
                        date:'dd/MM/yyyy' }}</p>
                    </div>
                  </div>
                  <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto">
                    <p-tag [value]="commonService.getTranslatedStatus(request.requestData.status)| titlecase" [severity]="commonService.getStatusSeverity(request.requestData.status)"
                      class="w-full sm:w-auto justify-center"></p-tag>
                    <a [routerLink]="['/detail-animal', request.animalData?.id]" class="w-full sm:w-auto">
                      <p-button icon="pi pi-eye" label="Ver Ficha" styleClass="p-button-outlined w-full"></p-button>
                    </a>
                  </div>
                </div>
              </div>
            </ng-container>

            <ng-template #noRequests>
              <div class="text-center p-5 border-2 border-dashed rounded-lg bg-surface-50">
                <i class="pi pi-folder-open text-4xl text-surface-400 mb-3"></i>
                <p class="m-0 font-semibold text-surface-600">Aún no has realizado ninguna solicitud.</p>
                <p class="text-sm text-surface-500 mt-1">¡Anímate a encontrar a tu nuevo mejor amigo!</p>
              </div>
            </ng-template>

            <ng-template #loadingRequests>
              <div class="flex justify-center p-5">
                <p-progressSpinner styleClass="w-8 h-8" strokeWidth="4"></p-progressSpinner>
              </div>
            </ng-template>
          </div>
        </ng-template>
      </p-card>
    </div>
  </div>
</div>
