<div class="requests-container">
  <p-toast></p-toast>
  <!-- Indicador de Carga -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando solicitudes...</p>
  </div>

  <!-- Mensaje de Error -->
  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- Contenido Principal -->
  <div *ngIf="!isLoading && !error">
    <!-- Mensaje si no hay solicitudes -->
    <div *ngIf="requests.length === 0" class="no-requests">
      <i class="fas fa-inbox"></i>
      <h2>No hay solicitudes pendientes</h2>
      <p>Cuando un usuario solicite adoptar un animal, aparecerá aquí.</p>
    </div>

    <!-- Lista de Solicitudes en formato Tabla -->
    <div *ngIf="requests.length > 0" class="table-container">
      <p-table #dt [value]="requests" dataKey="id" styleClass="p-datatable-striped" [expandedRowKeys]="expandedRows"
        [globalFilterFields]="['animalData.name', 'name', 'email', 'phone', 'address', 'status']">
        <ng-template pTemplate="caption">
      <div class="flex justify-content-end items-center gap-2">
        <div class="flex gap-2">
          <p-button icon="pi pi-refresh" (click)="loadRequests()" pTooltip="Recargar datos" tooltipPosition="top"
            styleClass="p-button-secondary p-button-outlined"></p-button>
        </div>

        <p-iconField iconPosition="left">
          <p-inputIcon>
            <i class="pi pi-search"></i>
          </p-inputIcon>
          <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')"
            placeholder="Buscar animales" />
        </p-iconField>
      </div>
    </ng-template>
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 4rem"></th> <!-- Columna para el expansor -->
            <th>Animal</th>
            <th>Solicitante</th>
            <th style="width: 12rem">Email</th>
            <th style="width: 10rem">Teléfono</th>
            <th style="width: 10rem">Dirección</th>
            <th style="width: 15rem">Estado</th>
            <th style="width: 10rem">Acciones</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-request let-expanded="expanded">
          <tr>
            <td>
              <button type="button" pButton pRipple [pRowToggler]="request"
                class="p-button-text p-button-rounded p-button-plain"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
            </td>
            <td>{{ request.animalData?.name || 'N/A' }}</td>
            <td>{{ request?.name || 'N/A' }}</td>
            <td>{{ request?.email || 'N/A' }}</td>
            <td>{{ request?.phone || 'N/A' }}</td>
            <td>{{ request?.address || 'N/A' }}</td>
            <td>
              <p-tag [value]="commonService.getTranslatedStatus(request.status)" [severity]="commonService.getStatusSeverity(request.status)" [icon]="commonService.getStatusIcon(request.status)"></p-tag>
            </td>
            <td>
              <div class="action-buttons">
                <ng-container>
                  <button pButton pRipple icon="pi pi-check" class="p-button-rounded p-button-text p-button-success"
                    (click)="approveRequest(request)" pTooltip="Aprobar" tooltipPosition="top" [disabled]="request.status === 'approved'"></button>
                  <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-warning"
                    (click)="requestCorrection(request)" pTooltip="Solicitar corrección" tooltipPosition="top" [disabled]="request.status === 'needs_correction'"></button>
                  <button pButton pRipple icon="pi pi-times" class="p-button-rounded p-button-text p-button-danger"
                    (click)="rejectRequest(request)" pTooltip="Rechazar" tooltipPosition="top" [disabled]="request.status === 'rejected'"></button>
                </ng-container>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="expandedrow" let-request>
          <tr>
            <td colspan="12">
              <div class="expanded-details">
                <div class="flex gap-4">
                  <!-- Columna Izquierda: Info Animal y Solicitante -->
                  <div class="w-1/3">
                    <h4>Información General</h4>
                    <hr class="mt-0">
                    <img [src]="request.animalData?.urlImage || 'assets/images/placeholder.png'"
                      [alt]="request.animalData?.name" class="expanded-animal-image">
                    <div class="info-grid mt-3">
                      <p><strong>Animal:</strong> {{ request.animalData?.name }}</p>
                      <p><strong>Solicitante:</strong> {{ request.name }}</p>
                      <p><strong>Email:</strong> {{ request.email }}</p>
                      <p><strong>Teléfono:</strong> {{ request.phone }}</p>
                      <p><strong>Dirección:</strong> {{ request.address }}</p>
                    </div>
                  </div>
                  <!-- Columna Derecha: Respuestas -->
                  <div class="w-1/2">
                    <h4>Respuestas del formulario</h4>
                    <hr class="mt-0">
                    <div class="question">
                      <span>1. ¿Cuántas horas al día pasaría el animal solo en casa?</span>
                      <p class="request-message">"{{ request.question1 || 'Sin respuesta.' }}"</p>
                    </div>
                    <div class="question">
                      <span>2. Si vives en un piso, ¿tienes terraza o balcón? ¿Están debidamente protegidos para evitar
                        caídas (redes, cerramientos)?</span>
                      <p class="request-message">"{{ request.question2 || 'Sin respuesta.' }}"</p>
                    </div>
                    <div class="question">
                      <span>3. ¿Hay zonas de la casa a las que el animal no podrá acceder?</span>
                      <p class="request-message">"{{ request.question3 || 'Sin respuesta.' }}"</p>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center">No se encontraron solicitudes.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>
