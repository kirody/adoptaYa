<div class="card flex justify-center" *ngIf="isLoading">
  <p-progress-spinner strokeWidth="4" fill="transparent" animationDuration=".0.5s"
    [style]="{ width: '50px', height: '50px' }" />
</div>
<p-menu #menu [model]="animalActions" [popup]="true" />
<div *ngIf="!isLoading && user">
  @if (dataTable && dataTable.length > 0) {
  <p-table #dt [value]="dataTable" [tableStyle]="{ 'min-width': '60rem' }"
    [globalFilterFields]="['id', 'name', 'gender', 'specie', 'protectressName', 'publishedText']" [paginator]="true"
    [rows]="10" [rowsPerPageOptions]="[5, 10, 20]" styleClass="p-datatable-striped">
    <ng-template pTemplate="caption">
      <div class="flex justify-content-end items-center gap-2">
        <div class="flex gap-2">
          <p-button icon="pi pi-refresh" (click)="refreshData()" pTooltip="Recargar datos" tooltipPosition="top"
            styleClass="p-button-secondary p-button-outlined"></p-button>
          <p-button *ngIf="initialFilter" label="Quitar filtro" icon="pi pi-filter-slash" severity="secondary"
            [outlined]="true" (click)="clearInitialFilter()"></p-button>
        </div>

        @if (user?.role === 'ROLE_MOD') {
        <p-button (click)="toggleHideAssignedToAdmin()" [label]="hideAssignedToAdmin ? 'Mostrar todos' : 'Ocultar'"
          [icon]="hideAssignedToAdmin ? 'pi pi-eye' : 'pi pi-eye-slash'" severity="info" [outlined]="true"
          pTooltip="Oculta los animales que ya están siendo revisados por un administrador"
          tooltipPosition="top"></p-button>
        }
        @if (user?.role === 'ROLE_ADMIN') {
        <p-button (click)="toggleShowOnlyAssignedToMe()"
          [label]="showOnlyAssignedToMe ? 'Mostrar todos' : 'Ver mis asignados'"
          [icon]="showOnlyAssignedToMe ? 'pi pi-eye' : 'fa-solid fa-user-check'" severity="info" [outlined]="true"
          pTooltip="Muestra solo los animales que te has asignado para revisar" tooltipPosition="top"></p-button>
        }
        <p-iconField iconPosition="left">
          <p-inputIcon>
            <i class="pi pi-search"></i>
          </p-inputIcon>
          <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')"
            placeholder="Buscar animales" />
        </p-iconField>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th>Imagen</th>
        <th>Nombre</th>
        <th>Especie</th>
        <th>Género</th>
        <th>Edad</th>
        <th>Estado</th>
        <th>Publicado</th>
        <th>Escalado</th>
        <th>Protectora</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-animal>
      <tr [ngClass]="{
            'bg-gray-100 opacity-70': user?.role === 'ROLE_MOD' && animal.assignedToAdmin,
            'bg-orange-50': user?.role === 'ROLE_ADMIN' && hasModeratorScaled(animal) && !animal.assignedToAdmin && animal.infraction !== 'pending_review',
            'bg-blue-50': user?.role === 'ROLE_ADMIN' && animal.assignedToAdmin,
            'needs-review-row': animal.infraction === 'pending_review'
          }" [pTooltip]="(user?.role === 'ROLE_MOD' && animal.assignedToAdmin) ?
          'Este caso está siendo gestionado por un administrador. No puedes realizar acciones.' : ''"
        tooltipPosition="top">
        <td>
          <img [src]="animal.urlImage" [alt]="animal.name" class="w-2rem rounded" />
        </td>
        <td>
          <span class="mr-2">{{ animal.name }}</span>
          @if(animal.isClone) {
          <i class="fa-solid fa-clone text-blue-500" pTooltip="Ficha clonada" tooltipPosition="top"></i>
          }
          @if(animal.infraction === 'pending_review') {
          <i class="fa-solid fa-flag text-red-500" pTooltip="Infracción detectada. Requiere revisión."
            tooltipPosition="top"></i>
          } @else if (animal.infraction === 'resolved') {
          <i class="fa-solid fa-shield-halved text-green-500" pTooltip="Infracción resuelta." tooltipPosition="top"></i>
          }
          @if(user?.role === 'ROLE_ADMIN' && hasModeratorScaled(animal) && !animal.assignedToAdmin &&
          getScaledStatusTag(animal) !== 'Cerrado') {
          <i class="fa-solid fa-triangle-exclamation text-orange-500" pTooltip="Requiere revisión"
            tooltipPosition="top"></i>
          }
          @if(user?.role === 'ROLE_ADMIN' && animal.assignedToAdmin) {
          <i class="fa-solid fa-user-check text-blue-500" pTooltip="Asignado a admin" tooltipPosition="top"></i>
          }
        </td>
        <td>
          <i class="fa-solid" [ngClass]="{'fa-cat': animal.specie === 'Gato', 'fa-dog': animal.specie === 'Perro'}"></i>
        </td>
        <td>
          <i class="fa-solid"
            [ngClass]="{'fa-mars': animal.gender === 'Macho', 'fa-venus': animal.gender === 'Hembra'}"></i>
        </td>
        <td>{{ animal.age | formattedAge}}</td>
        <td>
          <p-tag [value]="formattedStates(animal)" [severity]="getStatus(animal)" [rounded]="true" />
        </td>
        <td>
          <i class="fa-solid"
            [ngClass]="{'fa-circle-check text-green-500': animal.published, 'fa-circle-xmark text-red-500': !animal.published}"
            [pTooltip]="animal.published ? 'Publicado' : 'Sin publicar'" tooltipPosition="top"></i>
        </td>
        <td>
          @if (animal.scaled?.length > 0) {
          @if (getScaledStatusTag(animal); as status) {
          <p-button
            [icon]="['Cerrado', 'Asignado a admin'].includes(status) ? 'fa-solid fa-check' : 'fa-solid fa-clock'"
            [severity]="setColorTagScaled(status)" [rounded]="true" [text]="false" (click)="openModalScaled(animal)"
            pTooltip="Ver info" tooltipPosition="top" [label]="status" size="small"></p-button>
          }
          } @else {
          <i class="fa-solid fa-circle-xmark text-red-500" pTooltip="No escalado" tooltipPosition="top"></i>
          }
        </td>
        <td>{{ animal.protectressName }}</td>
        <td>
          <div class="flex">
            <!-- Editar -->
            <p-button icon="fa-solid fa-pen-to-square" styleClass="p-button-rounded p-button-warning p-button-text"
              (click)="editAnimal(animal.id)"
              [disabled]="isEditDisabled(animal) || (user?.role === 'ROLE_MOD' && (animal.assignedToAdmin || animal.published))"
              [pTooltip]="getEditTooltip(animal)" tooltipPosition="top"></p-button>
            <!-- Publicar/Despublicar -->
            <p-button icon="fa-solid"
              [ngClass]="{'fa-eye-slash': animal.published, 'fa-cloud-arrow-up': !animal.published}"
              styleClass="p-button-rounded p-button-success p-button-text"
              (click)="openConfirmationDialog(animal, 'publish')"
              [disabled]="isPublishDisabled(animal) || (user?.role === 'ROLE_MOD' && animal.assignedToAdmin) || animal.infraction === 'pending_review' || animal.isClone"
              [pTooltip]="getPublishTooltip(animal)" tooltipPosition="top"></p-button>

            @if (user?.role === 'ROLE_MOD' && !animal.published) {
            <!-- Escalar -->
            <p-button icon="fa-solid"
              [ngClass]="{'fa-comment': !hasModeratorScaled(animal), 'fa-comment-slash': hasModeratorScaled(animal)}"
              styleClass="p-button-rounded p-button-warning p-button-text" (click)="scaledAnimal(animal)"
              [disabled]="hasModeratorScaled(animal) || animal.assignedToAdmin"
              [pTooltip]="hasModeratorScaled(animal) ? 'Escalado' : 'Escalar a administrador'"
              tooltipPosition="top"></p-button>
            }
            <!-- Menú de más acciones -->
            <p-button icon="pi pi-ellipsis-v" styleClass="p-button-rounded p-button-secondary p-button-text"
              (click)="showAnimalActions($event, animal)" pTooltip="Más acciones" tooltipPosition="top"></p-button>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="10" class="text-center">No se encontraron resultados.</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="5" class="font-bold">Total {{ dataTable.length }} animales.</td>
      </tr>
    </ng-template>
  </p-table>
  } @else {
  <app-card-nodata message="No hay animales disponibles para gestionar."></app-card-nodata>
  }
</div>

<p-dialog [header]="'Escalar ' + selectedScaledAnimal()?.name" [modal]="true" [(visible)]="showModalScaled"
  [(visible)]="showModalScaled" [style]="{ width: '25rem' }" styleClass="modern-dialog" [draggable]="false"
  [resizable]="false">
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2 text-lg font-semibold text-primary">
      Escalar a {{selectedScaledAnimal()?.name | uppercase}}
      <i class='pi pi-arrow-right'></i> Administrador
    </div>
  </ng-template>
  <span class="p-text-secondary block mb-4">Envia un mensaje a un administrador para que revise tu caso.</span>
  <div class="flex items-center mb-4">
    <textarea rows="5" style="width: 100%;" pTextarea [(ngModel)]="scaleComment"
      placeholder="Escribe tu mensaje aqui..."></textarea>
  </div>
  <div class="flex justify-end gap-2">
    <p-button label="Cancelar" severity="secondary" (click)="showModalScaled = false" />
    <p-button label="Enviar" icon="pi pi-send" [disabled]="scaleComment === ''" (click)="sendScaledAnimal()" />
  </div>
</p-dialog>

<p-dialog [modal]="true" [(visible)]="showInfoScaled" (onHide)="onInfoModalHide()" [styleClass]="'modern-dialog'"
  [style]="{ width: '30rem' }" [draggable]="false" [resizable]="false">
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2 text-lg font-semibold text-primary">
      Información de Escalado
    </div>
  </ng-template>
  @if (selectedScaledAnimal()?.scaled?.length > 0) {
  <div class="p-fluid">
    <!-- Mensajes de Estado -->
    @if (showModPendingMessage()) {
    <p-message severity="info" styleClass="w-full mt-1 mb-3">
      <div class="flex items-center">
        <i class="pi pi-clock text-xl mr-3"></i>
        <div>
          <strong>Su petición se está revisando.</strong>
          <p class="mt-1">Un administrador está revisando su caso y le responderá en la mayor brevedad posible.</p>
        </div>
      </div>
    </p-message>
    }
    @if (showModResolvedMessage()) {
    <p-message severity="success" styleClass="w-full mt-1 mb-3">
      <div class="flex items-center">
        <i class="pi pi-check-circle text-xl mr-3"></i>
        <div>
          <strong>Caso revisado por un administrador.</strong>
          <p class="mt-1">El administrador ha dejado un comentario. Por favor, revise la información y proceda a
            publicar la ficha del animal.</p>
        </div>
      </div>
    </p-message>
    }
    @if (showAdminPendingMessage()) {
    <p-message severity="warn" styleClass="w-full mt-1 mb-3">
      <div class="flex items-center">
        <i class="pi pi-exclamation-triangle text-xl mr-3"></i>
        <div>
          <strong>Revisión Requerida</strong>
          <p class="mt-1">Este caso ha sido escalado por un moderador y necesita su atención.</p>
        </div>
      </div>
    </p-message>
    }
    @if (showAdminResolvedMessage()) {
    <p-message severity="info" styleClass="w-full mt-1 mb-3">
      <div class="flex items-center">
        <i class="pi pi-info-circle text-xl mr-3"></i>
        <div>
          <strong>Caso devuelto al moderador.</strong>
          <p class="mt-1">Ya ha respondido a este caso. El moderador revisará sus comentarios.</p>
        </div>
      </div>
    </p-message>
    }
    @if (showAdminToAssignedMessage()) {
    <p-message severity="warn" styleClass="w-full mt-1 mb-3">
      <div class="flex items-center">
        <i class="pi pi-info-circle text-xl mr-3"></i>
        <div>
          <strong>Caso asignado a un administrador.</strong>
          <p class="mt-1">Esta ficha ha sido asignada a un administrador para su revisión.</p>
        </div>
      </div>
    </p-message>
    }
    @if (showModToAssignedMessage()) {
    <p-message severity="secondary" styleClass="w-full mt-1 mb-3">
      <div class="flex items-center">
        <i class="pi pi-info-circle text-xl mr-3"></i>
        <div>
          <strong>Un administrador se ha asignado el caso.</strong>
          <p class="mt-1">Este caso está siendo gestionado por un administrador. No puedes realizar acciones.</p>
        </div>
      </div>
    </p-message>
    }

    <!-- Datos del escalado (Moderador) -->
    @if (moderatorData(); as moderator) {
    <div class="flex mb-2">
      <div class="col">
        <div class="field mb-2 text-sm">
          <div class="text-color-secondary mb-1">ID Ficha:</div>
          <div class="text-gray-400 text-sm">{{ moderator.animalData.id }}</div>
        </div>
        <div class="field mb-2 text-sm">
          <div class="text-color-secondary mb-1">Escalado por:</div>
          <div class="font-medium">{{moderator.name}} ({{moderator.email}})</div>
        </div>
      </div>
      <div class="col">
        <div class="field mb-2 text-sm">
          <div class="text-color-secondary mb-1">Ficha Escalada:</div>
          <div class="font-medium">{{moderator.animalData.name}}</div>
        </div>
        <div class="field mb-2 text-sm">
          <div class="text-color-secondary mb-1">Fecha y hora:</div>
          <div class="font-medium">{{moderator.dateHour.date }} {{moderator.dateHour.hour }}</div>
        </div>
      </div>
    </div>
    }

    <!-- Comentarios de la conversación -->
    <div>
      <div class="field mb-4 text-sm">
        <!-- Mensajes del Moderador -->
        @if (moderatorData(); as modData) {
        <div class="flex justify-content-end">
          <div class="content-message">
            <p><strong>{{modData.name}}</strong> (Moderador)</p>
            <p>{{ modData.comment }}</p>
          </div>
        </div>
        }
        @if (adminData(); as adminData) {
        <div class="flex justify-content-start mt-2">
          <div class="content-message">
            <p><strong>{{adminData.name}}</strong> (Administrador)</p>
            <p>{{ adminData.comment }}</p>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Panel de acción para el administrador -->
    @if (showAdminActionPanel()) {
    <div class="flex items-center mb-4 mt-4">
      <textarea rows="3" style="width: 100%;" pTextarea [(ngModel)]="scaleComment"
        placeholder="Escribe tu mensaje aqui..."></textarea>
    </div>
    }

    <!-- Botones de acción -->
    <div class="flex justify-content-end flex-wrap pt-3 border-top-1 surface-border gap-2">
      @if (showModeratorCloseButton() || showAdminCloseButton()) {
      <p-button label="Cerrar" icon="pi pi-times" severity="secondary" (click)="showInfoScaled = false"
        class="p-button-outlined" />
      }
      @if (showAdminActionPanel()) {
      <p-button label=" " severity="danger" class="p-button-outlined" (click)="resolveScaled('toAdmin')"
        [disabled]="scaleComment === ''">
        Admin <i class="fa-solid fa-arrow-left mx-1"></i> Mod
      </p-button>
      <p-button label=" " severity="success" (click)="resolveScaled('toMod')" [disabled]="scaleComment === ''">
        Admin <i class="fa-solid fa-arrow-right mx-1"></i> Mod
      </p-button>
      }
    </div>
  </div>
  }
</p-dialog>

<p-dialog [(visible)]="displayConfirmationDialog" [modal]="true" [style]="{width: '30rem'}" [draggable]="false"
  [resizable]="false" styleClass="modern-dialog">
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2 text-lg font-semibold"
      [ngClass]="confirmationActionType === 'delete' ? 'text-red-600' : 'text-primary'">
      <i [class]="confirmationIcon"></i>
      <span>{{ confirmationHeader }}</span>
    </div>
  </ng-template>

  <div class="p-fluid">
    <div class="flex flex-col items-center text-center p-4 rounded-lg border-1" [ngClass]="{
      'bg-red-50 border-red-200 text-red-800': confirmationActionType === 'delete',
      'bg-green-50 border-green-200 text-green-800': confirmationActionType === 'publish' && !confirmationAnimal?.published,
      'bg-yellow-50 border-yellow-200 text-yellow-800': confirmationActionType === 'publish' && confirmationAnimal?.published
    }">
      <i class="text-4xl mb-3" [ngClass]="confirmationIcon"></i>
      <p class="text-lg m-0 font-medium" [innerHTML]="confirmationMessage"></p>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" (click)="displayConfirmationDialog = false" />
    <p-button [label]="acceptButtonLabel" [icon]="acceptButtonIcon" [severity]="acceptButtonSeverity"
      (click)="confirmAction()" />
  </ng-template>
</p-dialog>

<p-dialog [(visible)]="displayAssignmentDialog" [modal]="true" [style]="{width: '30rem'}" [draggable]="false"
  [resizable]="false" styleClass="modern-dialog">
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2 text-lg font-semibold"
      [ngClass]="assignmentActionType === 'unassign' ? 'text-orange-600' : 'text-green-600'">
      <i [class]="assignmentIcon"></i>
      <span>{{ assignmentHeader }}</span>
    </div>
  </ng-template>

  <div class="flex flex-col items-center text-center p-4 rounded-lg border-1" [ngClass]="{
      'bg-green-50 border-green-200 text-green-800': assignmentActionType === 'assign',
      'bg-orange-50 border-orange-200 text-orange-800': assignmentActionType === 'unassign'
    }">
    <i class="text-4xl mb-3" [ngClass]="assignmentIcon"></i>
    <p class="text-lg m-0 font-medium" [innerHTML]="assignmentMessage"></p>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" (click)="displayAssignmentDialog = false" />
    <p-button [label]="assignmentAcceptLabel" [severity]="assignmentAcceptSeverity" (click)="confirmAssignmentAction()" />
  </ng-template>
</p-dialog>

<p-toast />
<p-confirmdialog />
