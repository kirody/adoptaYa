<div class="card flex justify-center" *ngIf="isLoading">
  <p-progress-spinner strokeWidth="4" fill="transparent" animationDuration=".0.5s"
    [style]="{ width: '50px', height: '50px' }" />
</div>
<p-menu #menu [model]="animalActions" [popup]="true" />
<div *ngIf="!isLoading && user">
  @if (dataTable && dataTable.length > 0) {
  <p-table #dt [value]="dataTable" [tableStyle]="{ 'min-width': '60rem' }"
    [globalFilterFields]="['id', 'name', 'gender', 'specie', 'protectressName', 'publishedText']"
    [(selection)]="selectedAnimals" (onRowSelect)="onSelectionChange($event)"
    (onRowUnselect)="onSelectionChange($event)" dataKey="id" [paginator]="true" [rows]="10"
    [rowsPerPageOptions]="[5, 10, 20]" styleClass="p-datatable-striped">
    <ng-template pTemplate="caption">
      <div class="flex justify-content-between items-center gap-2">
        <div class="flex gap-2">
          <!-- Acciones en Lote -->
          <p-button label="Publicar" icon="pi pi-cloud-upload" severity="success" [disabled]="isPublishBulkDisabled"
            (click)="openBulkConfirmationDialog('publish')" pTooltip="Publicar seleccionados" tooltipPosition="top"
            [rounded]="true" size="small" />
          @if (user?.role === 'ROLE_ADMIN') {
          <p-button label="Asignarme" icon="fa-solid fa-user-check" severity="info" [disabled]="isAssignBulkDisabled"
            (click)="openBulkConfirmationDialog('assign')" pTooltip="Asignarme seleccionados" tooltipPosition="top"
            [rounded]="true" size="small" />
          }
          <p-button label="Eliminar" icon="pi pi-trash" severity="danger" [disabled]="isDeleteBulkDisabled"
            (click)="openBulkConfirmationDialog('delete')" pTooltip="Eliminar seleccionados" tooltipPosition="top"
            [rounded]="true" size="small" />

          <p-divider layout="vertical" *ngIf="!isUnpublishBulkDisabled"></p-divider>

          <p-button label="Despublicar" icon="pi pi-eye-slash" (click)="openBulkConfirmationDialog('unpublish')"
            pTooltip="Despublicar seleccionados" tooltipPosition="top" [rounded]="true" size="small"
            *ngIf="!isUnpublishBulkDisabled" variant="outlined" />
        </div>
        <div class="flex gap-2">
          <!-- Filtros y Búsqueda -->
          <div class="flex gap-2">
            <p-button icon="pi pi-refresh" (click)="refreshData()" pTooltip="Recargar datos" tooltipPosition="top"
              styleClass="p-button-secondary p-button-outlined"></p-button>
            <p-button *ngIf="initialFilter" label="Quitar filtro" icon="pi pi-filter-slash" severity="secondary"
              [outlined]="true" (click)="clearInitialFilter()"></p-button>
          </div>
          <div class="flex gap-2">
            <p-iconField iconPosition="left">
              <p-inputIcon>
                <i class="pi pi-search"></i>
              </p-inputIcon>
              <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                placeholder="Buscar animales" />
            </p-iconField>
          </div>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox />
        </th>
        <th>Imagen</th>
        <th>Nombre</th>
        <th>Especie</th>
        <th>Género</th>
        <th>Edad</th>
        <th>Estado</th>
        <th>Publicado</th>
        <th>Escalado</th>
        <th>Protectora</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-animal>
      <tr [ngClass]="{
            'bg-blue-50': user?.role === 'ROLE_ADMIN' && animal.assignedToAdmin,
            'needs-review-row': animal.infraction === 'pending_review'
          }" tooltipPosition="top">
        <td>
          <p-tableCheckbox [value]="animal" />
        </td>
        <td>
          <p-image [src]="animal.urlImage" [alt]="animal.name" imageClass="w-2rem rounded" [preview]="true" />
        </td>
        <td>
          <div class="flex items-center gap-2">
            <span class="font-bold">{{ animal.name }}</span>
            <i *ngIf="animal.featured" class="fa-solid fa-star text-yellow-500" pTooltip="Animal destacado"
              tooltipPosition="top"></i>

            @if(animal.isClone) {
            <i class="fa-solid fa-clone text-blue-500" pTooltip="Ficha clonada" tooltipPosition="top"></i>
            }
            @if(animal.infraction === 'pending_review') {
            <i class="fa-solid fa-flag text-red-500" pTooltip="Infracción detectada. Requiere revisión."
              tooltipPosition="top"></i>
            } @else if (animal.infraction === 'resolved') {
            <i class="fa-solid fa-shield-halved text-green-500" pTooltip="Infracción resuelta"
              tooltipPosition="top"></i>
            }
            @if(user?.role === 'ROLE_ADMIN' && animal.assignedToAdmin) {
            <i class="fa-solid fa-user-check text-blue-500" pTooltip="Asignado a admin" tooltipPosition="top"></i>
            }
          </div>
        </td>
        <td>
          <i class="fa-solid" [ngClass]="{'fa-cat': animal.specie === 'Gato', 'fa-dog': animal.specie === 'Perro'}"></i>
        </td>
        <td>
          <i class="fa-solid"
            [ngClass]="{'fa-mars': animal.gender === 'Macho', 'fa-venus': animal.gender === 'Hembra'}"></i>
        </td>
        <td>{{ animal.age | formattedAge}}</td>
        <td>
          <p-tag [value]="commonService.getTranslatedStatus(animal.state)"
            [severity]="commonService.getStatusSeverity(animal.state)" [rounded]="true" />
        </td>
        <td>
          <i class="fa-solid"
            [ngClass]="{'fa-circle-check text-green-500': animal.published, 'fa-circle-xmark text-red-500': !animal.published}"
            [pTooltip]="animal.published ? 'Publicado' : 'Sin publicar'" tooltipPosition="top"></i>
        </td>
        <td>
          <i *ngIf="animal.hasScalingTicket" class="fa-solid fa-arrow-up-right-dots text-orange-500"
            pTooltip="Este animal tiene un ticket de escalado abierto" tooltipPosition="top">
          </i>
        </td>
        <td>{{ animal.protectressName }}</td>
        <td>
          <div class="flex">
            <!-- Editar -->
            <p-button icon="fa-solid fa-pen-to-square" styleClass="p-button-rounded p-button-warning p-button-text"
              (click)="editAnimal(animal.id)" [disabled]="animal.published" tooltipPosition="top"></p-button>
            <!-- Publicar/Despublicar -->
            <p-button icon="fa-solid"
              [ngClass]="{'fa-eye-slash': animal.published, 'fa-cloud-arrow-up': !animal.published}"
              styleClass="p-button-rounded p-button-success p-button-text"
              (click)="openConfirmationDialog(animal, 'publish')"
              [disabled]="animal.infraction === 'pending_review' || animal.isClone" tooltipPosition="top"></p-button>

            <!-- Menú de más acciones -->
            <p-button icon="pi pi-ellipsis-v" styleClass="p-button-rounded p-button-secondary p-button-text"
              (click)="showAnimalActions($event, animal)" pTooltip="Más acciones" tooltipPosition="top"></p-button>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="11" class="text-center">No se encontraron resultados.</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="5" class="font-bold">Total {{ dataTable.length }} animales.</td>
      </tr>
    </ng-template>
  </p-table>
  } @else {
  <app-card-nodata message="No hay animales disponibles para gestionar."></app-card-nodata>
  }
</div>

<p-dialog [(visible)]="displayConfirmationDialog" [modal]="true" [style]="{width: '30rem'}" [draggable]="false"
  [resizable]="false" styleClass="modern-dialog">
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2 text-lg font-semibold"
      [ngClass]="confirmationActionType === 'delete' ? 'text-red-600' : 'text-primary'">
      <i [class]="confirmationIcon"></i>
      <span>{{ confirmationHeader }}</span>
    </div>
  </ng-template>

  <div class="p-fluid">
    <div class="flex flex-col items-center text-center p-4 rounded-lg border-1" [ngClass]="{
      'bg-red-50 border-red-200 text-red-800': confirmationActionType === 'delete',
      'bg-green-50 border-green-200 text-green-800': confirmationActionType === 'publish' && !confirmationAnimal?.published,
      'bg-yellow-50 border-yellow-200 text-yellow-800': confirmationActionType === 'publish' && confirmationAnimal?.published
    }">
      <i class="text-4xl mb-3" [ngClass]="confirmationIcon"></i>
      <p class="text-lg m-0 font-medium" [innerHTML]="confirmationMessage"></p>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" (click)="displayConfirmationDialog = false" />
    <p-button [label]="acceptButtonLabel" [icon]="acceptButtonIcon" [severity]="acceptButtonSeverity"
      (click)="confirmAction()" />
  </ng-template>
</p-dialog>

<p-dialog [(visible)]="displayAssignmentDialog" [modal]="true" [style]="{width: '30rem'}" [draggable]="false"
  [resizable]="false" styleClass="modern-dialog">
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2 text-lg font-semibold"
      [ngClass]="assignmentActionType === 'unassign' ? 'text-orange-600' : 'text-green-600'">
      <i [class]="assignmentIcon"></i>
      <span>{{ assignmentHeader }}</span>
    </div>
  </ng-template>

  <div class="flex flex-col items-center text-center p-4 rounded-lg border-1" [ngClass]="{
      'bg-green-50 border-green-200 text-green-800': assignmentActionType === 'assign',
      'bg-orange-50 border-orange-200 text-orange-800': assignmentActionType === 'unassign'
    }">
    <i class="text-4xl mb-3" [ngClass]="assignmentIcon"></i>
    <p class="text-lg m-0 font-medium" [innerHTML]="assignmentMessage"></p>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" (click)="displayAssignmentDialog = false" />
    <p-button [label]="assignmentAcceptLabel" [severity]="assignmentAcceptSeverity"
      (click)="confirmAssignmentAction()" />
  </ng-template>
</p-dialog>

<p-dialog header="ID del Animal" [(visible)]="displayIdModal" [modal]="true" [style]="{width: '25rem'}"
  [draggable]="false" [resizable]="false" styleClass="modern-dialog">
  @if (selectedAnimalForId) {
  <div class="flex flex-col items-center text-center p-4">
    <p class="mb-2">El ID del animal <strong>{{selectedAnimalForId.name}}</strong> es:</p>
    <div class="p-3 bg-gray-100 border-1 border-gray-300 rounded-md w-full">
      <span class="font-mono text-lg">{{selectedAnimalForId.id}}</span>
    </div>
  </div>
  }
  <ng-template pTemplate="footer">
    <p-button label="Cerrar" severity="secondary" (click)="displayIdModal = false" />
  </ng-template>
</p-dialog>

<!-- Diálogo de Confirmación para Acciones en Lote -->
<p-dialog [(visible)]="displayBulkConfirmationDialog" [modal]="true" [style]="{width: '30rem'}" [draggable]="false"
  [resizable]="false" styleClass="modern-dialog" (onHide)="resetBulkConfirmationState()">
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2 text-lg font-semibold" [ngClass]="{
      'text-red-600': bulkActionType === 'delete',
      'text-yellow-600': bulkActionType === 'unpublish',
      'text-blue-600': bulkActionType === 'assign',
      'text-primary': bulkActionType === 'publish'
    }">
      <span>{{ bulkConfirmationHeader }}</span>
    </div>
  </ng-template>

  <div class="p-fluid">
    <p class="m-0" [innerHTML]="bulkConfirmationMessage"></p>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" (click)="displayBulkConfirmationDialog = false" />
    <p-button [label]="bulkAcceptButtonLabel" [severity]="bulkAcceptButtonSeverity" (click)="confirmBulkAction()" />
  </ng-template>
</p-dialog>


<p-toast />
<p-confirmdialog />
