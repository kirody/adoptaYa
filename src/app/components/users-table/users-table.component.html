<div class="card flex justify-center" *ngIf="isLoading">
  <p-progress-spinner strokeWidth="4" fill="transparent" animationDuration=".0.5s"
    [style]="{ width: '50px', height: '50px' }" />
</div>
<div *ngIf="!isLoading && user">
  @if (dataTable && dataTable.length > 0) {
  <p-table [value]="dataTable" [tableStyle]="{ 'min-width': '60rem' }">
    <ng-template #caption />
    <ng-template #header>
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Rol</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template #body let-user>
      <tr>
        <td>{{ user.username }} </td>
        <td>{{ user.email }} </td>
        <td>
          <div class="field">
            <p-select id="state" [(ngModel)]="user.role" [options]="roles" optionLabel="label" optionValue="value"
              placeholder="Selecciona un rol" styleClass="w-full" (onChange)="updateRolUser(user)" filter="true"
              appendTo="body" [disabled]="user.role === 'ROLE_ADMIN'">
            </p-select>
          </div>
        </td>
        <td *ngIf="user.role !== 'ROLE_ADMIN'">
          <p-button [icon]="user.isSuspended ? 'fa-solid fa-user-check' : 'fa-solid fa-user-slash'"
            [pTooltip]="user.isSuspended ? 'Reactivar usuario' : 'Suspender usuario'" tooltipPosition="top"
            [severity]="user.isSuspended ? 'success' : 'danger'" styleClass="p-button-rounded p-button-text"
            (click)="confirmSuspension($event, user)"></p-button>
          <p-button icon="pi pi-comment" pTooltip="Enviar mensaje" tooltipPosition="top"
            styleClass="p-button-rounded p-button-text"
            (click)="openMessageDialog(user)"></p-button>
        </td>
      </tr>
    </ng-template>
    <ng-template #footer>
      <tr>
        <td colspan="5" class="font-bold">Total {{ dataTable.length }} usuarios registrados.
        </td>
      </tr>
    </ng-template>
  </p-table>
  } @else {
  <app-card-nodata message="No hay usuarios disponibles para gestionar."></app-card-nodata>
  }
</div>

<p-dialog header="Enviar Mensaje a {{ selectedUser?.username }}" [(visible)]="displayMessageDialog" [modal]="true"
  [style]="{ width: '450px' }">
  <div class="message-history">
    <p-progressSpinner *ngIf="isHistoryLoading" [style]="{width: '30px', height: '30px'}" strokeWidth="6"
      animationDuration=".5s"></p-progressSpinner>

    <div *ngIf="!isHistoryLoading && messageHistory.length === 0" class="no-history">
      <i class="pi pi-history"></i>
      <p>No hay mensajes anteriores.</p>
    </div>

    <div *ngFor="let msg of messageHistory" class="history-item">
      <p class="history-message">{{ msg.message }}</p>
      <span class="history-date">{{ msg.date.toDate() | date:'short' }}</span>
    </div>
  </div>

  <div class="field">
    <textarea rows="5" cols="30" pInputTextarea [(ngModel)]="messageContent" placeholder="Escribe tu mensaje aquÃ­..."
      class="w-full"></textarea>
  </div>
  <ng-template pTemplate="footer">
    <p-button icon="pi pi-times" (click)="closeMessageDialog()" label="Cerrar"
      styleClass="p-button-text"></p-button>
    <p-button icon="pi pi-send" (click)="sendMessage()" label="Enviar" styleClass="p-button-text"
      [disabled]="!messageContent.trim()"></p-button>
  </ng-template>
</p-dialog>
