<div class="card flex justify-center" *ngIf="isLoading">
  <p-progress-spinner strokeWidth="4" fill="transparent" animationDuration=".0.5s"
    [style]="{ width: '50px', height: '50px' }" />
</div>
<div *ngIf="!isLoading && user">
  @if (dataTable && dataTable.length > 0) {
  <p-table #dt [value]="dataTable" [tableStyle]="{ 'min-width': '60rem' }" [globalFilterFields]="['username', 'email']">
    <ng-template pTemplate="caption">
      <div class="flex justify-between items-center">
        <h3 class="m-0"></h3>
        <p-iconField iconPosition="left">
          <p-inputIcon>
            <i class="pi pi-search"></i>
          </p-inputIcon>
          <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')" placeholder="Buscar usuarios" />
        </p-iconField>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Permisos</th>
        <th>Rol</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template #body let-user>
      <tr>
        <td>{{ user.username }} </td>
        <td>{{ user.email }} </td>
        <td>
          <div class="field">
            <p-multiSelect [options]="availablePermissions" [(ngModel)]="user.permissions"
              (onChange)="updatePermissions(user)" optionValue="value" defaultLabel="Asignar permisos" optionLabel="label"
              display="chip" appendTo="body" styleClass="w-full" selectedItemsLabel="{0} permisos"
              [disabled]="user.isSuspended || user.role !== 'ROLE_MOD'">
            </p-multiSelect>
          </div>
        </td>
        <td>
          <div class="field">
            <p-select id="state" [(ngModel)]="user.role" [options]="roles" optionLabel="label" optionValue="value"
              placeholder="Selecciona un rol" styleClass="w-full" (onChange)="updateRolUser(user)" filter="true"
              appendTo="body" [disabled]="user.isSuspended">
            </p-select>
          </div>
        </td>
        <td>
          <p-button [icon]="user.isSuspended ? 'fa-solid fa-user-check' : 'fa-solid fa-user-slash'"
            [pTooltip]="user.isSuspended ? 'Reactivar usuario' : 'Suspender usuario'" tooltipPosition="top"
            [severity]="user.isSuspended ? 'success' : 'danger'" styleClass="p-button-rounded p-button-text"
            (click)="confirmSuspension($event, user)"></p-button>
        </td>
      </tr>
    </ng-template>
    <ng-template #footer>
      <tr>
        <td colspan="6" class="font-bold">Total {{ dataTable.length }} usuarios registrados.
        </td>
      </tr>
    </ng-template>
  </p-table>
  } @else {
  <app-card-nodata message="No hay usuarios disponibles para gestionar."></app-card-nodata>
  }
</div>
