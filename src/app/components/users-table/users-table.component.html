<div class="card flex justify-center" *ngIf="isLoading">
  <p-progress-spinner strokeWidth="4" fill="transparent" animationDuration=".0.5s"
    [style]="{ width: '50px', height: '50px' }" />
</div>
<div *ngIf="!isLoading && user">
  @if (dataTable && dataTable.length > 0) {
  <p-table #dt [value]="dataTable" [tableStyle]="{ 'min-width': '60rem' }" [globalFilterFields]="['username', 'email']">
    <ng-template pTemplate="caption">
      <div class="flex justify-between items-center">
        <h3 class="m-0"></h3>
        <p-iconField iconPosition="left">
          <p-inputIcon>
            <i class="pi pi-search"></i>
          </p-inputIcon>
          <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')" placeholder="Buscar usuarios" />
        </p-iconField>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Permisos</th>
        <th>Rol</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template #body let-user>
      <tr>
        <td>{{ user.username }} </td>
        <td>{{ user.email }} </td>
        <td>
          <div class="field">
            <p-multiSelect [options]="availablePermissions" [(ngModel)]="user.permissions"
              (onChange)="updatePermissions(user)" optionValue="value" defaultLabel="Asignar permisos" optionLabel="label"
              display="chip" appendTo="body" styleClass="w-full" selectedItemsLabel="{0} permisos"
              [disabled]="user.isSuspended || user.role !== 'ROLE_MOD'">
            </p-multiSelect>
          </div>
        </td>
        <td>
          <div class="field">
            <p-select id="state" [(ngModel)]="user.role" [options]="roles" optionLabel="label" optionValue="value"
              placeholder="Selecciona un rol" styleClass="w-full" (onChange)="updateRolUser(user)" filter="true"
              appendTo="body" [disabled]="user.isSuspended">
            </p-select>
          </div>
        </td>
        <td>
          <p-button [icon]="user.isSuspended ? 'fa-solid fa-user-check' : 'fa-solid fa-user-slash'"
            [pTooltip]="user.isSuspended ? 'Reactivar usuario' : 'Suspender usuario'" tooltipPosition="top"
            [severity]="user.isSuspended ? 'success' : 'danger'" styleClass="p-button-rounded p-button-text"
            (click)="confirmSuspension($event, user)"></p-button>
          <p-button icon="fa-solid fa-key" pTooltip="Restablecer contraseña" tooltipPosition="top"
            styleClass="p-button-rounded p-button-text p-button-info"
            (click)="confirmPasswordReset($event, user)"></p-button>
          <p-button icon="fa-solid fa-clipboard-list" pTooltip="Ver/Añadir notas internas" tooltipPosition="top"
            styleClass="p-button-rounded p-button-text p-button-secondary"
            (click)="openNotesDialog(user)"></p-button>
        </td>
      </tr>
    </ng-template>
    <ng-template #footer>
      <tr>
        <td colspan="6" class="font-bold">Total {{ dataTable.length }} usuarios registrados.
        </td>
      </tr>
    </ng-template>
  </p-table>
  } @else {
  <app-card-nodata message="No hay usuarios disponibles para gestionar."></app-card-nodata>
  }

  <!-- Dialog for Internal Notes -->
  <p-dialog header="Notas Internas sobre {{selectedUserForNotes?.username}}" [(visible)]="displayNotesDialog"
    [modal]="true" [style]="{width: '50vw'}" [draggable]="false" [resizable]="false">
    <div class="notes-container">
      @if (selectedUserForNotes?.notes && selectedUserForNotes?.notes.length > 0) {
      <ul class="list-none p-0 m-0 space-y-4">
        @for (note of selectedUserForNotes.notes | orderByDate:'desc'; track note) {
        <li class="note-record border rounded-lg overflow-hidden shadow-sm">
          <div class="note-header bg-surface-50 p-3 flex justify-between items-center border-b ">
            <div class="font-semibold text-surface-700 flex items-center gap-2">
              <p-avatar [label]="note.authorName.charAt(0).toUpperCase()" shape="circle" size="normal" [style]="getUserAvatarColor(note.authorName)"></p-avatar>
              <span>{{note.authorName}}</span>
            </div>
            <span class="text-sm text-surface-500">{{note.createdAt.toDate() | date:'dd/MM/yyyy HH:mm'}}</span>
          </div>
          <div class="note-body p-3">
            <p class="m-0 text-surface-800">{{note.content}}</p>
          </div>
        </li>
        }
      </ul>
      } @else {
      <p class="text-center text-surface-500">No hay notas para este usuario.</p>
      }
    </div>
    <div class="new-note-section mt-4 pt-4 border-t">
      <textarea pInputTextarea [(ngModel)]="notesContent" rows="3" class="w-full"
        placeholder="Escribe una nueva nota..."></textarea>
      <div class="flex justify-between items-center mt-1">
        <small class="p-text-secondary">Máximo 80 carácteres.</small>
        <small [ngClass]="{'text-red-500 font-bold': notesContent.length > MAX_NOTE_LENGTH, 'p-text-secondary': notesContent.length <= MAX_NOTE_LENGTH}">
          {{notesContent.length}} / {{MAX_NOTE_LENGTH}}
        </small>
      </div>
      @if (notesContent.length > MAX_NOTE_LENGTH) {
        <div class="p-2 mt-2 bg-yellow-100 border-round-md text-yellow-800 flex align-items-center">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            <span>La nota es demasiado larga. Usa <strong>'Resumir con IA'</strong> para acortarla.</span>
        </div>
      }
    </div>

    <div class="quick-messages mt-3">
      <h4 class="font-semibold mb-2 text-sm">Notas rápidas</h4>
      <div class="flex flex-wrap gap-2">
        <p-button label="Contacto telefónico realizado" icon="pi pi-phone" severity="info" [outlined]="true" size="small"
          (click)="addQuickNote('Se ha contactado por teléfono con el usuario para verificar la información.')" />
        <p-button label="Verificación completada" icon="pi pi-check-circle" severity="success" [outlined]="true" size="small"
          (click)="addQuickNote('Se han verificado los datos del usuario. Perfil validado.')" />
        <p-button label="Advertencia enviada" icon="pi pi-exclamation-triangle" severity="warn" [outlined]="true"
          size="small" (click)="addQuickNote('Se ha enviado una advertencia al usuario por comportamiento inadecuado.')" />
        <p-button label="Solicitud rechazada" icon="pi pi-times-circle" severity="danger" [outlined]="true" size="small"
          (click)="addQuickNote('Se ha rechazado una solicitud de adopción de este usuario.')" />
        <p-button label="Usuario no contactado" icon="pi pi-question-circle" severity="secondary" [outlined]="true"
          size="small" (click)="addQuickNote('Se ha intentado contactar con el usuario sin éxito. Posiblemente inactivo.')" />
      </div>
    </div>

    <ng-template pTemplate="footer" class="flex items-center justify-between">
      <p-button label="Cerrar" size="small" icon="pi pi-times" (click)="displayNotesDialog=false" styleClass="p-button-text" />
      <p-button label="Resumir con IA" size="small" icon="pi pi-sparkles" (click)="summarizeNote()" [disabled]="!notesContent.trim()" [loading]="isSummarizing" styleClass="p-button-help p-button-sm" />
      <p-button label="Guardar Nota" size="small" icon="pi pi-check" (click)="addNote()" [disabled]="!notesContent.trim() || notesContent.length > MAX_NOTE_LENGTH" [loading]="isAddingNote"/>
    </ng-template>
  </p-dialog>
</div>
