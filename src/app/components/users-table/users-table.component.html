<div class="card flex justify-center" *ngIf="isLoading">
  <p-progress-spinner strokeWidth="4" fill="transparent" animationDuration=".0.5s"
    [style]="{ width: '50px', height: '50px' }" />
</div>
<p-menu #menu [model]="userActions" [popup]="true" />
<div *ngIf="!isLoading && user">
  @if (dataTable && dataTable.length > 0) {
  <p-table #dt [value]="dataTable" [tableStyle]="{ 'min-width': '60rem' }"
    [globalFilterFields]="['username', 'email', 'status']" styleClass="p-datatable-striped">
    <ng-template pTemplate="caption">
      <div class="flex justify-content-end items-center gap-2">
        <div class="flex gap-2">
          <p-button icon="pi pi-refresh" (click)="refreshData()" pTooltip="Recargar datos" tooltipPosition="top"
            styleClass="p-button-secondary p-button-outlined"></p-button>
        </div>

        <p-iconField iconPosition="left">
          <p-inputIcon>
            <i class="pi pi-search"></i>
          </p-inputIcon>
          <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')"
            placeholder="Buscar animales" />
        </p-iconField>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Permisos</th>
        <th>Estado</th>
        <th>Rol</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template #body let-user>
      <tr>
        <td>{{ user.username }} </td>
        <td>{{ user.email }} </td>
        <td>
          <div class="field">
            <p-multiSelect [options]="availablePermissions" [(ngModel)]="user.permissions"
              (onChange)="updatePermissions(user)" optionValue="value" defaultLabel="Asignar permisos"
              optionLabel="label" display="chip" appendTo="body" styleClass="w-full" selectedItemsLabel="{0} permisos"
              [disabled]="user.status !== 'active' || user.role !== 'ROLE_MOD'">
            </p-multiSelect>
          </div>
        </td>
        <td>
          <p-tag [value]="getTranslatedStatus(user.status)" [severity]="getStatusSeverity(user.status)">
            <i *ngIf="user.status === 'infraction'" class="fa-solid fa-triangle-exclamation"
              pTooltip="Este usuario tiene una infracción pendiente de revisión" tooltipPosition="top"></i>
          </p-tag>
        </td>
        <td>
          <div class="field">
            <p-select id="state" [(ngModel)]="user.role" [options]="roles" optionLabel="label" optionValue="value"
              placeholder="Selecciona un rol" styleClass="w-full" (onChange)="updateRolUser(user)" filter="true"
              appendTo="body" [disabled]="user.status !== 'active'">
            </p-select>
          </div>
        </td>
        <td>
          <div class="flex">
            <!-- Botón para Activar nuevos moderadores -->
            <p-button *ngIf="user.status === 'pending_activation'" icon="fa-solid fa-user-plus"
              pTooltip="Activar nuevo moderador" tooltipPosition="top" severity="success"
              styleClass="p-button-rounded p-button-text" (click)="confirmActivation($event, user)"></p-button>
            <!-- Botón para Suspender/Reactivar -->
            <p-button
              *ngIf="user.status === 'active' || user.status === 'suspended' || user.status === 'automatic_suspension'"
              [icon]="user.status === 'active' ? 'fa-solid fa-user-slash' : 'fa-solid fa-user-check'"
              [pTooltip]="user.status === 'active' ? 'Suspender usuario' : 'Reactivar usuario'" tooltipPosition="top"
              [severity]="user.status === 'active' ? 'danger' : 'success'" styleClass="p-button-rounded p-button-text"
              (click)="confirmSuspension($event, user)"></p-button>
            <!-- Menú de más acciones -->
            <p-button icon="pi pi-ellipsis-v" styleClass="p-button-rounded p-button-secondary p-button-text"
              (click)="showUserActions($event, user)" pTooltip="Más acciones" tooltipPosition="top" />
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template #footer>
      <tr>
        <td colspan="6" class="font-bold">Total {{ dataTable.length }} usuarios registrados.
        </td>
      </tr>
    </ng-template>
  </p-table>
  } @else {
  <app-card-nodata message="No hay usuarios disponibles para gestionar."></app-card-nodata>
  }

  <!-- Dialog for Internal Notes -->
  <p-dialog header="Notas Internas sobre {{selectedUserForNotes?.username}}" [(visible)]="displayNotesDialog"
    [modal]="true" [style]="{width: '50vw'}" [draggable]="false" [resizable]="false">
    <div class="notes-container pr-4" style="max-height: 125px; overflow-y: auto;">
      @if (selectedUserForNotes?.notes && selectedUserForNotes?.notes.length > 0) {
      <ul class="list-none p-0 m-0 space-y-4">
        @for (note of selectedUserForNotes.notes | orderByDate:'desc'; track note) {
        <li class="note-record border rounded-lg overflow-hidden shadow-sm">
          <div class="note-header bg-surface-50 p-3 flex justify-between items-center border-b ">
            <div class="font-semibold text-surface-700 flex items-center gap-2">
              <p-avatar [label]="note.authorName.charAt(0).toUpperCase()" shape="circle" size="normal"
                [style]="getUserAvatarColor(note.authorName)"></p-avatar>
              <span>{{note.authorName}}</span>
            </div>
            <span class="text-sm text-surface-500">{{note.createdAt.toDate() | date:'dd/MM/yyyy HH:mm'}}</span>
          </div>
          <div class="note-body p-3">
            <p class="m-0 text-surface-800">{{note.content}}</p>
          </div>
        </li>
        }
      </ul>
      } @else {
      <p class="text-center text-surface-500">No hay notas para este usuario.</p>
      }
    </div>
    <div class="new-note-section mt-4 pt-4 border-t">
      <textarea pInputTextarea [(ngModel)]="notesContent" rows="3" class="w-full"
        placeholder="Escribe una nueva nota..."></textarea>
      <div class="flex justify-between items-center mt-1">
        <small class="p-text-secondary">Máximo 80 carácteres.</small>
        <small
          [ngClass]="{'text-red-500 font-bold': notesContent.length > MAX_NOTE_LENGTH, 'p-text-secondary': notesContent.length <= MAX_NOTE_LENGTH}">
          {{notesContent.length}} / {{MAX_NOTE_LENGTH}}
        </small>
      </div>
      @if (notesContent.length > MAX_NOTE_LENGTH) {
      <div class="p-2 mt-2 bg-yellow-100 border-round-md text-yellow-800 flex align-items-center">
        <i class="pi pi-exclamation-triangle mr-2"></i>
        <span>La nota es demasiado larga. Usa <strong>'Resumir con IA'</strong> para acortarla.</span>
      </div>
      }
    </div>

    <div class="quick-messages mt-3">
      <h4 class="font-semibold mb-2 text-sm">Notas rápidas</h4>
      <div class="flex flex-wrap gap-2">
        <p-button label="Contacto telefónico realizado" icon="pi pi-phone" severity="info" [outlined]="true"
          size="small"
          (click)="addQuickNote('Se ha contactado por teléfono con el usuario para verificar la información.')" />
        <p-button label="Verificación completada" icon="pi pi-check-circle" severity="success" [outlined]="true"
          size="small" (click)="addQuickNote('Se han verificado los datos del usuario. Perfil validado.')" />
        <p-button label="Advertencia enviada" icon="pi pi-exclamation-triangle" severity="warn" [outlined]="true"
          size="small"
          (click)="addQuickNote('Se ha enviado una advertencia al usuario por comportamiento inadecuado.')" />
        <p-button label="Solicitud rechazada" icon="pi pi-times-circle" severity="danger" [outlined]="true" size="small"
          (click)="addQuickNote('Se ha rechazado una solicitud de adopción de este usuario.')" />
        <p-button label="Usuario no contactado" icon="pi pi-question-circle" severity="secondary" [outlined]="true"
          size="small"
          (click)="addQuickNote('Se ha intentado contactar con el usuario sin éxito. Posiblemente inactivo.')" />
      </div>
    </div>

    <ng-template pTemplate="footer" class="flex items-center justify-between">
      <p-button label="Cerrar" size="small" icon="pi pi-times" (click)="displayNotesDialog=false"
        styleClass="p-button-text" />
      <p-button label="Resumir con IA" size="small" icon="pi pi-sparkles" (click)="summarizeNote()"
        [disabled]="!notesContent.trim()" [loading]="isSummarizing" styleClass="p-button-help p-button-sm" />
      <p-button label="Guardar Nota" size="small" icon="pi pi-check" (click)="addNote()"
        [disabled]="!notesContent.trim() || notesContent.length > MAX_NOTE_LENGTH" [loading]="isAddingNote" />
    </ng-template>
  </p-dialog>

  <!-- Dialog for Infraction Details -->
  <p-dialog header="Historial de Infracciones de {{selectedUserForInfraction?.username}}"
    [(visible)]="displayInfractionDialog" [modal]="true" [style]="{width: '50vw'}" [draggable]="false"
    [resizable]="false">
    @if (infractionHistory.length > 0) {
    <p-accordion [(value)]="activeInfractionAccordionPanels" [multiple]="true">
      @for (infraction of infractionHistory; track infraction.id; let i = $index) {
      <p-accordion-panel [value]="i.toString()">
        <p-accordion-header>
          <div class="flex align-items-center gap-2 w-full">
            <i class="pi pi-exclamation-triangle text-orange-500"></i>
            <span class="font-bold">Infracción #{{ infractionHistory.length - i }}</span>
            <span class="flex-1 text-right font-normal text-sm text-gray-500">{{ infraction.timestamp.toDate() |
              date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
        </p-accordion-header>
        <p-accordion-content>
          <div class="infraction-details">
            <div class="field mb-3">
              <label class="font-semibold">Usuario asociado:</label>
              <span class="ml-2">{{ infraction.userData.userEmail || 'N/A' }}</span>
            </div>
            <div class="field mb-3">
              <label class="font-semibold">Entidad afectada:</label>
              <span class="ml-2 capitalize">{{infraction.context.entityId}} {{ infraction.context.entity || 'N/A'
                }}</span>
            </div>
            <div class="field mb-3">
              <label class="font-semibold">Campo afectado:</label>
              <span class="ml-2">{{ infraction.context.fieldName || 'N/A' }}</span>
            </div>
            <div class="field mb-3">
              <label class="font-semibold">Palabras afectadas:</label>
              <span class="ml-2">{{ infraction.context.infringingWords?.join(', ')|| 'N/A' }}</span>
            </div>
            <div class="field mb-3">
              <label class="font-semibold">Estado de la infracción:</label>
              <p-tag [value]="infraction.status === 'pending_review' ? 'Pendiente de revisión' : 'Desconocido'"
                [severity]="getStatusSeverity(infraction.status)"></p-tag>
            </div>
            <div class="field mb-3" *ngIf="infraction.actionTaken">
              <label class="font-semibold">Acción tomada:</label>
              <p-tag
                [value]="infraction.actionTaken === 'user_suspended' ? 'Suspensión automática' : infraction.actionTaken"
                severity="info"></p-tag>
            </div>
            <div class="field">
              <label class="font-semibold">Contenido reportado:</label>
              <div class="reported-content border-1 surface-border p-3 border-round mt-2 bg-surface-50">
                <p class="m-0" style="white-space: pre-wrap;">{{ infraction.context.infringingText }}</p>
              </div>
            </div>
          </div>
        </p-accordion-content>
      </p-accordion-panel>
      }
    </p-accordion>
    } @else {
    <div class="flex flex-col items-center justify-center text-center p-5">
      <i class="pi pi-check-circle text-green-500 text-4xl mb-3"></i>
      <h3 class="font-bold text-lg">Todo en orden</h3>
      <p class="text-surface-500">Este usuario no tiene infracciones registradas.</p>
    </div>
    }
    <ng-template pTemplate="footer">
      <p-button label="Cerrar" icon="pi pi-times" (click)="displayInfractionDialog=false" styleClass="p-button-text" />
    </ng-template>
  </p-dialog>

  <p-dialog [(visible)]="displaySuspensionConfirmationDialog" [modal]="true" [style]="{ width: '45rem' }"
    [draggable]="false" [resizable]="false" [closable]="false" styleClass="p-dialog-irreversible">
    <ng-template pTemplate="header">
      <div class="flex items-center justify-center w-full gap-3 p-2 bg-red-600 text-white rounded-t-lg"
      *ngIf="showResetWarning">
        <i class="pi pi-shield text-3xl"></i>
        <span class="font-bold text-2xl">Acción con Consecuencias Permanentes</span>
      </div>
    </ng-template>

    <div class="p-fluid">
      <div class="flex flex-col items-center text-center p-4 mb-4 rounded-lg border-1" [ngClass]="{
        'bg-red-50 border-red-200 text-red-800': confirmationAction === 'suspender',
        'bg-green-50 border-green-200 text-green-800': confirmationAction === 'reactivar'
      }">
        <i class="text-4xl mb-3" [ngClass]="{
          'pi pi-exclamation-triangle': confirmationAction === 'suspender',
          'pi pi-check-circle': confirmationAction === 'reactivar'
        }"></i>
        <p class="text-lg m-0 font-medium">
          Estás a punto de <strong>{{ confirmationAction }}</strong> al usuario <strong>{{ confirmationUser?.username }}</strong>.
        </p>
      </div>
      <!-- Panel de Consecuencias -->
      <div *ngIf="showResetWarning" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-left mt-5">
        <p class="font-bold text-lg text-gray-800 mb-3">Por favor, revisa y confirma las siguientes consecuencias:</p>

        <ul class="list-none p-0 m-0 space-y-4">
          <!-- Motivo de la Suspensión -->
          <li class="flex items-start gap-3 bg-blue-50 p-3 rounded-lg border-l-4 border-blue-400">
            <i class="pi pi-info-circle text-2xl text-blue-600 mt-1"></i>
            <div>
              <h4 class="font-bold m-0 text-blue-800">Contexto de la Suspensión</h4>
              <p class="text-sm m-0 text-blue-700">
                Este usuario fue suspendido automáticamente por el sistema al alcanzar el límite de <strong>3 strikes</strong>.
              </p>
            </div>
          </li>

          <!-- Consecuencia 1: Eliminación de Animales -->
          <li *ngIf="pendingAnimalNames.length > 0" class="flex items-start gap-3">
            <i class="pi pi-folder-open text-2xl text-yellow-600 mt-1"></i>
            <div class="w-full">
              <h4 class="font-bold m-0">Eliminación de Fichas de Animales ({{pendingAnimalNames.length}})</h4>
              <p class="text-sm m-0">
                Al no haberse solucionado las infracciones pendientes, las siguientes fichas serán <strong>eliminadas permanentemente</strong>:
                <strong class="block mt-1 text-yellow-800">{{ pendingAnimalNames.join(', ') }}</strong>
              </p>
            </div>
          </li>

          <!-- Consecuencia 2: Reseteo de Historial -->
          <li class="flex items-start gap-3">
            <i class="pi pi-trash text-2xl text-red-600 mt-1"></i>
            <div>
              <h4 class="font-bold m-0">Borrado del Historial de Infracciones</h4>
              <p class="text-sm m-0">
                El historial de infracciones del usuario y sus strikes se <strong>resetearán a 0</strong>. Esta acción no se puede deshacer.
              </p>
            </div>
          </li>
        </ul>

        <!-- Campo de confirmación -->
        <div class="mt-5 pt-4 border-t border-dashed">
          <label for="confirmation-input" class="block text-sm font-bold text-gray-700 mb-2">Para confirmar esta acción irreversible, escribe
            <strong>{{ confirmationAction }}</strong>:</label>
          <input id="confirmation-input" type="text" pInputText [(ngModel)]="confirmationInput" class="w-full"
            placeholder="Escribe para confirmar..." />
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button label="Cancelar" icon="pi pi-times" (click)="onRejectSuspension()"
        styleClass="p-button-secondary"></p-button>
      <p-button [label]="confirmationAction | titlecase" icon="pi pi-check"
        [styleClass]="confirmationAction === 'suspender' ? 'p-button-danger' : 'p-button-success'"
        (click)="onConfirmSuspension()"
        [disabled]="showResetWarning && confirmationInput !== confirmationAction"></p-button>
    </ng-template>
  </p-dialog>
</div>
